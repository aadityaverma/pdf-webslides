<html>
<head>
<style>
body, html {
    margin: 0;
    padding: 0;
    background-color: #000;
}
img#slide {
    float: left;
}
img#slide-next {
    float: right;
}
#slide-annot {
    color: white;
    font-size: 200%;
    white-space: pre;
    font-family: 'sans serif',Verdana,Arial;
    margin: 1em;
}
#icons {
    color: white;
/*     float: left; */
    position: absolute;
    bottom: 4px;
}
div#timer {
    font-size: 3em;
    cursor: hand;
    font-family: "Lucida Console", Monaco, monospace;
    text-align: center;
}
div#footer {
    position: absolute;
    bottom: 4px; 
    color: white;
    width: 100%;
}
#pages {
    color: white;
    position: absolute;
    right: 4px;
    bottom: 4px;
    font-size: 1.5em;
    font-family: "Lucida Console", Monaco, monospace;
}
</style>
</head>
<body onload="init()">
<img id="slide" height="100%"/>
<img id="slide-next" style="display: none;"/><span id="slide-annot" style="display: none;"></span>
<input type="button" onclick="openSlides()" value="Open slides" style="display: none;" id="open-btn" />
<div id="footer">
<div id="icons"><span style="display: none;" id="freeze"><img src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9JzEwMHB4JyB3aWR0aD0nMTAwcHgnICBmaWxsPSIjZmZmZmZmIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGRhdGEtbmFtZT0iTGF5ZXIgMSIgdmlld0JveD0iMCAwIDI0IDI0IiB4PSIwcHgiIHk9IjBweCI+PHRpdGxlPnN2Zyw8L3RpdGxlPjxwYXRoIGQ9Ik0yMS41LDEzLjUyN2EuNi42LDAsMCwxLS40MjQuNzM1bC0yLjcwNy43MjVMMjAuOTYsMTYuNDhhLjYuNiwwLDEsMS0uNiwxLjAzOWwtMi41ODYtMS40OTMuNzI1LDIuNzA4YS42LjYsMCwwLDEtLjQyNC43MzUuNjExLjYxMSwwLDAsMS0uMTU1LjAyMS42LjYsMCwwLDEtLjU3OS0uNDQ1bC0xLjAzNS0zLjg2NkwxMi42LDEzLjAzOXY0LjI3OGwyLjgzLDIuODNhLjYuNiwwLDEsMS0uODQ4Ljg0OUwxMi42LDE5LjAxNFYyMmEuNi42LDAsMSwxLTEuMiwwVjE5LjAxNEw5LjQxOCwyMWEuNi42LDAsMSwxLS44NDgtLjg0OWwyLjgzLTIuODNWMTMuMDM5bC0zLjcwNiwyLjE0TDYuNjU5LDE5LjA0NGEuNi42LDAsMCwxLS41NzkuNDQ1LjYxMS42MTEsMCwwLDEtLjE1NS0uMDIxLjYuNiwwLDAsMS0uNDI0LS43MzVsLjcyNS0yLjcwOEwzLjY0LDE3LjUyYS42LjYsMCwxLDEtLjYtMS4wMzlsMi41ODYtMS40OTMtMi43MDctLjcyNUEuNi42LDAsMCwxLDMuMjI5LDEzLjFMNy4xLDE0LjEzOSwxMC44LDEyLDcuMSw5Ljg2MSwzLjIyOSwxMC45YS42MTEuNjExLDAsMCwxLS4xNTUuMDIxLjYuNiwwLDAsMS0uMTU1LTEuMThsMi43MDctLjcyNUwzLjA0LDcuNTJhLjYuNiwwLDAsMSwuNi0xLjAzOUw2LjIyNiw3Ljk3NCw1LjUsNS4yNjZhLjYuNiwwLDEsMSwxLjE1OC0uMzExTDcuNjk0LDguODIxbDMuNzA2LDIuMTRWNi42ODNMOC41NywzLjg1M0EuNi42LDAsMCwxLDkuNDE4LDNMMTEuNCw0Ljk4NlYyYS42LjYsMCwxLDEsMS4yLDBWNC45ODZMMTQuNTgyLDNhLjYuNiwwLDAsMSwuODQ4Ljg0OUwxMi42LDYuNjgzdjQuMjc4bDMuNzA2LTIuMTQsMS4wMzUtMy44NjZhLjYuNiwwLDEsMSwxLjE1OC4zMTFsLS43MjUsMi43MDhMMjAuMzYsNi40OGEuNi42LDAsMCwxLC42LDEuMDM5TDE4LjM3NCw5LjAxM2wyLjcwNy43MjVhLjYuNiwwLDAsMS0uMTU1LDEuMTguNjExLjYxMSwwLDAsMS0uMTU1LS4wMjFMMTYuOSw5Ljg2MSwxMy4yLDEybDMuNywyLjEzOUwyMC43NzEsMTMuMUEuNi42LDAsMCwxLDIxLjUsMTMuNTI3WiI+PC9wYXRoPjwvc3ZnPg==" /></span><span style="display: none;" id="black"><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyAgIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIiAgIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyIgICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgICB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiICAgeG1sbnM6aW5rc2NhcGU9Imh0dHA6Ly93d3cuaW5rc2NhcGUub3JnL25hbWVzcGFjZXMvaW5rc2NhcGUiICAgaGVpZ2h0PSIxMDBweCIgICB3aWR0aD0iMTAwcHgiICAgZmlsbD0iI2ZmZmZmZiIgICB2aWV3Qm94PSIwIDAgMzIgMzIiICAgeD0iMHB4IiAgIHk9IjBweCIgICB2ZXJzaW9uPSIxLjEiICAgaWQ9InN2ZzgiICAgc29kaXBvZGk6ZG9jbmFtZT0ibm91bl9Nb25pdG9yXzI4NjAxNTkuc3ZnIiAgIGlua3NjYXBlOnZlcnNpb249IjAuOTIuMyAoMjQwNTU0NiwgMjAxOC0wMy0xMSkiPiAgPG1ldGFkYXRhICAgICBpZD0ibWV0YWRhdGExNCI+ICAgIDxyZGY6UkRGPiAgICAgIDxjYzpXb3JrICAgICAgICAgcmRmOmFib3V0PSIiPiAgICAgICAgPGRjOmZvcm1hdD5pbWFnZS9zdmcreG1sPC9kYzpmb3JtYXQ+ICAgICAgICA8ZGM6dHlwZSAgICAgICAgICAgcmRmOnJlc291cmNlPSJodHRwOi8vcHVybC5vcmcvZGMvZGNtaXR5cGUvU3RpbGxJbWFnZSIgLz4gICAgICA8L2NjOldvcms+ICAgIDwvcmRmOlJERj4gIDwvbWV0YWRhdGE+ICA8ZGVmcyAgICAgaWQ9ImRlZnMxMiIgLz4gIDxzb2RpcG9kaTpuYW1lZHZpZXcgICAgIHBhZ2Vjb2xvcj0iI2ZmZmZmZiIgICAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IiAgICAgYm9yZGVyb3BhY2l0eT0iMSIgICAgIG9iamVjdHRvbGVyYW5jZT0iMTAiICAgICBncmlkdG9sZXJhbmNlPSIxMCIgICAgIGd1aWRldG9sZXJhbmNlPSIxMCIgICAgIGlua3NjYXBlOnBhZ2VvcGFjaXR5PSIwIiAgICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIgICAgIGlua3NjYXBlOndpbmRvdy13aWR0aD0iMTkyMCIgICAgIGlua3NjYXBlOndpbmRvdy1oZWlnaHQ9IjEwMTUiICAgICBpZD0ibmFtZWR2aWV3MTAiICAgICBzaG93Z3JpZD0iZmFsc2UiICAgICBpbmtzY2FwZTp6b29tPSI0LjcyIiAgICAgaW5rc2NhcGU6Y3g9Ii0xOC4zNzU5NzUiICAgICBpbmtzY2FwZTpjeT0iNzQuNDc0OTkzIiAgICAgaW5rc2NhcGU6d2luZG93LXg9IjAiICAgICBpbmtzY2FwZTp3aW5kb3cteT0iMCIgICAgIGlua3NjYXBlOndpbmRvdy1tYXhpbWl6ZWQ9IjEiICAgICBpbmtzY2FwZTpjdXJyZW50LWxheWVyPSJzdmc4IiAvPiAgPHRpdGxlICAgICBpZD0idGl0bGUyIj5wYyBidXNpbmVzcyB0ZWNobm9sb2d5IHN0cmF0ZWd5IGNvbW11bmljYXRpb24gam9iIHByb2Zlc3Npb25hbDwvdGl0bGU+ICA8ZyAgICAgaWQ9Imc2IiAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZiI+ICAgIDxwYXRoICAgICAgIGQ9Ik0zMCwzSDJBMSwxLDAsMCwwLDEsNFYyMmExLDEsMCwwLDAsMSwxSDEzdjJIOS4xMUExLjExLDEuMTEsMCwwLDAsOCwyNi4xMVYyN0gyNHYtLjg5QTEuMTEsMS4xMSwwLDAsMCwyMi44OSwyNUgxOVYyM0gzMGExLDEsMCwwLDAsMS0xVjRBMSwxLDAsMCwwLDMwLDNaTTI5LDIxSDNWNUgyOVoiICAgICAgIGlkPSJwYXRoNCIgICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZiIgLz4gIDwvZz4gIDxnICAgICBpZD0iZzg0MCIgICAgIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuNjc3MzU2OTcsMC4xOTA2NjcxNykiICAgICBzdHlsZT0iZmlsbDojZmZmZmZmO3N0cm9rZTojZmZmZmZmIj4gICAgPHBhdGggICAgICAgaW5rc2NhcGU6Y29ubmVjdG9yLWN1cnZhdHVyZT0iMCIgICAgICAgaWQ9InBhdGg4MjEiICAgICAgIGQ9Ik0gMTAuOTc4MTMyLDguNzAxNDMwNyAxOS42NzkxNDEsMTcuNDAyNDQiICAgICAgIHN0eWxlPSJmaWxsOiNmZmZmZmY7c3Ryb2tlOiNmZmZmZmY7c3Ryb2tlLXdpZHRoOjEuOTIwMDAwMDg7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOm1pdGVyO3N0cm9rZS1taXRlcmxpbWl0OjQ7c3Ryb2tlLWRhc2hhcnJheTpub25lO3N0cm9rZS1vcGFjaXR5OjEiIC8+ICAgIDxwYXRoICAgICAgIGlua3NjYXBlOmNvbm5lY3Rvci1jdXJ2YXR1cmU9IjAiICAgICAgIGlkPSJwYXRoODIxLTMiICAgICAgIGQ9Im0gMTkuNjY3MTU0LDguNjg5NDQ2IC04LjcwMTAwOSw4LjcwMTAwOCIgICAgICAgc3R5bGU9ImZpbGw6I2ZmZmZmZjtzdHJva2U6I2ZmZmZmZjtzdHJva2Utd2lkdGg6MS45MTk5OTk5NjtzdHJva2UtbGluZWNhcDpyb3VuZDtzdHJva2UtbGluZWpvaW46bWl0ZXI7c3Ryb2tlLW1pdGVybGltaXQ6NDtzdHJva2UtZGFzaGFycmF5Om5vbmU7c3Ryb2tlLW9wYWNpdHk6MSIgLz4gIDwvZz48L3N2Zz4=" /></span></div>

<div style="display: none;" id="timer" onclick="setTimer()" oncontextmenu="switchTimerFormat(); return false;">00:00:00</div>
<div style="display: none;" id="pages">0/0</div>
</div>
<script>
    var slide = 0;
    var x = 0;
    var presenter = false;
    var slides = null;
    var freeze = false;
    var duration = 0;
    var start_time = 0;
    var timer_running = false;
    var black = false;
    var show_hours = true;

    function next() {
        if(slide < slide_img.length - 2) slide++;
        redraw();
    }

    function prev() {
        if(slide > 0) slide--;
        redraw();
    }
    
    function goto(sid) {
        slide = sid;
        redraw();
    }

    function redraw() {
        document.getElementById("slide").src = (black && !presenter) ? "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" : "data:image/svg+xml;base64," + slide_img[slide];
        if(presenter) {
            if(slide_img[slide + 1] != 0) {
                document.getElementById("slide-next").src = "data:image/svg+xml;base64," + slide_img[slide + 1];
            } else {
                document.getElementById("slide-next").src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=";
            }
            document.getElementById("slide-annot").innerHTML = atob(slide_annot[slide]);
            document.getElementById("pages").innerHTML = (slide + 1) + "/" + (slide_img.length - 1);
            
            if(slides && !freeze) {
                try {
                    slides.goto(slide);
                } catch(e) {
                    slides.postMessage({"action": "goto", "data": slide}, "*");
                }
            }
            
            presentationTimer();
        }
    }
    
    function setTimer() {
        var new_duration = parseInt(window.prompt("Presentation duration (in minutes)", Math.floor(duration / 60 / 1000))) * 60 * 1000;
        if(!isNaN(new_duration)) duration = new_duration;
    }
    
    function switchTimerFormat() {
        show_hours = !show_hours;
        timer_running = true;
        redraw();
    }
    
    function formatTime(ms) {
        var neg = false;
        if(ms < 0) {
            neg = true;
            ms = -ms;
        }
        ms /= 1000;
        var sec = Math.floor(ms % 60).toString();
        if(sec.length == 1) sec = "0" + sec;
        var min = Math.floor(ms / 60);
        if(show_hours) {
            var hour = Math.floor(min / 60).toString();
            min = (min % 60).toString();
            if(min.length == 1) min = "0" + min;
            if(hour.length == 1) hour = "0" + hour;
            return (neg ? "-" : "") + hour + ":" + min + ":" + sec;
        } else {
            min = min.toString();
            if(min.length == 1) min = "0" + min;
            return (neg ? "-" : "") + min + ":" + sec;
        }
    }
    
    function presentationTimer() {
        var running = Date.now() - start_time;
        if(!timer_running) {
            running = 0;
        }
        var tdisp = document.getElementById("timer");
        if(duration != 0) {
            tdisp.innerHTML = formatTime(duration - running);
        } else {
            tdisp.innerHTML = formatTime(running);
        }
    }

    function unify(e) {
        e = e || window.event;
        return e.changedTouches ? e.changedTouches[0] : e
    };

    function move(e) {
        e.preventDefault();
        x = unify(e).clientX;
    }

    function stop(e) {
        e.preventDefault();
        var new_x = unify(e).clientX;
        if(new_x > x) prev();
        else next();
    }

    function openSlides() {
        slides = window.open(document.location.href.replace(/\?presenter/g, "?presentslides"));
        try {
            slides.goto(slide);
        } catch(e) {
            window.setTimeout(function() {
                slides.postMessage({"action": "goto", "data": slide}, "*");
            }, 100);
        }
    }
    
    
    function receiveMessage(event) {
        if(event.data.action !== undefined && event.data.action == "goto") {
            goto(event.data.data);
        }
        if(event.data.action !== undefined && event.data.action == "black") {
            black = event.data.data;
            redraw();
        }
        //console.log(event);
    }

    function init() {
        var font_size = 200;
    
        if(document.location.href.indexOf("?presenter") != -1) {
            presenter = true;
            document.getElementById("slide").style.width="70%";
            document.getElementById("slide").style.height="auto";
            document.getElementById("slide-next").style.width="30%";
            document.getElementById("open-btn").style.display = "block";
            document.getElementById("slide-next").style.display = "block";
            document.getElementById("slide-annot").style.display = "";
            document.getElementById("timer").style.display = "";
            document.getElementById("pages").style.display = "";
            document.getElementById("pages").innerHTML = "1/" + (slide_img.length - 1);
            window.setInterval(presentationTimer, 200);
        }
        var img = document.getElementById("slide");
        img.addEventListener('wheel', function(e) {
            e = e || window.event;
            e.preventDefault();
            if(e.deltaY < 0) {
                prev();
            } else {
                next();
            }
        });

        window.addEventListener("keydown", function(e) {
            e = e || window.event;
            if(e.keyCode === 37 /*|| e.keyCode === 38*/) {
                e.preventDefault();
                prev();
            } else if(e.keyCode == 39 /*|| e.keyCode === 40*/) {
                e.preventDefault();
                if(!timer_running) {
                    timer_running = true;
                    start_time = Date.now();
                }
                next();
            } else if(e.key == "+") {
                font_size += 10;
                document.getElementById("slide-annot").style.fontSize = font_size + "%";
            } else if(e.key == "-") {
                font_size -= 10;
                document.getElementById("slide-annot").style.fontSize = font_size + "%";
            } else if(e.key == "f") {
                freeze = !freeze;
                if(presenter) document.getElementById("freeze").style.display = freeze ? "" : "none";
                redraw();
            } else if(e.key == "r") {
                start_time = Date.now();
                redraw();
                timer_running = false;
            } else if(e.key == "b") {
                black = !black;
                if(presenter) document.getElementById("black").style.display = black ? "" : "none";
                if(presenter && slides) {
                    try {
                        slides.black = black;
                    } catch(e) {
                        slides.postMessage({"action": "black", "data": black}, "*");
                    }
                }
                redraw();
            } else console.log(e.keyCode);
        });

        img.addEventListener("touchstart", move);
        img.addEventListener("touchend", stop);
        img.addEventListener("touchmove", function(e) {
            e.preventDefault()
        }, false);

        if(!presenter) window.addEventListener("message", receiveMessage, false);
       
        redraw();
    };
    
